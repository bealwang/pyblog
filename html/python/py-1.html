<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset="utf-8" >
    <meta name = "author" content = "genialwang" >
    <meta name = "description" content="基于python的静态博客系统"><meta name = "Keywords" content="python, 静态, 博客, 代码高亮">
    <title>基于python的静态博客系统</title>

    <link rel="stylesheet" href="../../static/css/uikit.almost-flat.min.css" />
    <link rel="stylesheet" href="../../static/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../../static/css/font-awesome-ie7.min.css" />
    <link rel="stylesheet" href="../../static/css/components/slidenav.almost-flat.min.css" />
    <link rel="stylesheet" href="../../static/css/highlight.css" />
    <link rel="stylesheet" href="../../static/css/style.css" />
    <link rel="stylesheet" href="../../static/css/components/sticky.almost-flat.min.css" />
    <link rel="stylesheet" href="../../static/css/components/dotnav.almost-flat.min.css" />
    <link rel="stylesheet" href="../../static/css/components/pygments.css" />
    <link rel="stylesheet" href="../../static/css/genialwang.css" />
    <script type="text/x-mathjax-config"> 
        MathJax.Hub.Config({ 
            tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]} 
        }); 
    </script>
    <script type="text/javascript"
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
</head>
<body>
    <div class="uk-margin-bottom" data-uk-sticky>
        <nav class="uk-navbar uk-navbar-attached uk-margin-bottom">
            <div class="uk-container uk-container-center">
                <a href="../../aboutme.html" class="uk-navbar-brand">GenialWang</a>
                <ul class="uk-navbar-nav">
                    <li><a href="../../index.html"><i class="uk-icon-book"></i> 博客</a></li>
                    <li><a href="../../aboutme.html"><i class="uk-icon-user"></i> 关于我</a></li>
                </ul>
            </div>
        </nav>
    </div>

    <div class="uk-container uk-container-center">
        <div class="uk-grid">
            <div class="uk-width-medium-1-5" id="my_navigation">
                <div data-uk-sticky="{top:60, boundary:true}">
                    <ul class="uk-dotnav uk-flex-column" data-uk-scrollspy-nav="{closest:'li', smoothscroll:true}">
                        <li class="uk-active"><a href="#toc-0">引言</a></li>
                        
                        
                        <li><a href="#toc-1">主要需求</a></li>
                        
                        
                        <li><a href="#toc-2">运行环境</a></li>
                        
                        
                        <li><a href="#toc-3">构建前端框架</a></li>
                        
                        
                        <li><a href="#toc-4">解析Markdown</a></li>
                        
                        
                        <li><a href="#toc-5">SEO</a></li>
                        
                        
                        <li><a href="#toc-6">扩展功能</a></li>
                        
                        
                        <li><a href="#toc-7">其他</a></li>
                        
                        
                   </ul>
                </div>
            </div>
        
            <div class="uk-width-medium-4-5 uk-container-center" id="my_blog">
                <div class="uk-panel uk-panel-box" id="my_title">
                    <h1>基于python的静态博客系统</h1>
                </div>
                <div class="uk-panel uk-panel-box" id="my_content">
                    <h2 id="toc-0">引言</h2>
<p>当前流行的博客系统有很多,博主简单介绍两款:</p>
<ul>
<li>WordPress(WP):一个巨无霸的存在,但是博主在WP中并没有找到能很好支持markdown的插件.很多人离开的原因很
简单,它看起来越来越不像是一个博客系统了...</li>
<li>Hexo:这是一款台湾大学生的作品.相比于WP,hexo是一个基于node.js的小萝莉.作为一款轻量级的静态博客系统
,hexo越来越受人青睐.</li>
</ul>
<p>好了,如果你觉得Hexo已经可以满足你的需求,那你就可以跳过本文了.但是如果你觉得WP实在是过于臃肿;如果你觉
得Hexo仍然存在很多冗余的东西;如果你想自主开发一个简单但却不平凡的博客系统,那么你可以参考本文的做法.
(下文将本文实现的博客系统称为pyblog)</p>
<h2 id="toc-1">主要需求</h2>
<ul>
<li>容易操作和使用</li>
<li>博客快速生成</li>
<li>支持markdown</li>
<li>页面风格可定制</li>
</ul>
<h2 id="toc-2">运行环境</h2>
<ul>
<li>python2.7</li>
<li>jinja2 == 2.8</li>
<li>pygments == 2.0.2</li>
<li>mistune == 0.7</li>
</ul>
<h2 id="toc-3">构建前端框架</h2>
<p>一个简洁优雅的前端界面可以让博客看起来更加舒适,本文结合前端框架<a href="http://getuikit.com/">uikit</a>和一些第
三方JQuery插件进行前端界面的构建.界面采用平面化的风格,适当地添加了平滑滚动效果以增加用户体验.</p>
<div class="uk-alert uk-alert-warning">

    <i class="uk-icon-warning"></i>

    博主对uikit原生的配色和布局方案可能略作改动,请谨慎使用
</div><h2 id="toc-4">解析Markdown</h2>
<p>得益于Mistune的使用,pyblog可以方便地将markdown文件解析为html文件.但是只是解析还不行,我们还有代码高亮
等一系列的需求尚未得到满足.</p>
<h3>代码高亮</h3>
<p>首先,在pygment的帮助下,博主解决了代码高亮的问题.简单地说,pygment就是一个渲染代码的工具,它支持论坛,百
科等等页面中的超过300种语言书写的代码的高亮.</p>
<p>令人欣喜的是,pygment可以和Mistune配合使用来高亮markdown中的由符号<b class="uk-text-success">```</b>包起来
的代码.按照Mistune的文档重写block_code模块.</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#highlight.py</span>
<span class="kn">import</span> <span class="nn">mistune</span>
<span class="kn">from</span> <span class="nn">pygments</span> <span class="kn">import</span> <span class="n">highlight</span>
<span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="kn">import</span> <span class="n">get_lexer_by_name</span>
<span class="kn">from</span> <span class="nn">pygments.formatters</span> <span class="kn">import</span> <span class="n">HtmlFormatter</span>

<span class="k">def</span> <span class="nf">block_code</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">inlinestyles</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">linenos</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lang</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">u&#39;&lt;pre&gt;&lt;code&gt;</span><span class="si">%s</span><span class="s">&lt;/code&gt;&lt;/pre&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">mistune</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">get_lexer_by_name</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">stripall</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">HtmlFormatter</span><span class="p">(</span>
            <span class="n">noclasses</span><span class="o">=</span><span class="n">inlinestyles</span><span class="p">,</span> <span class="n">linenos</span><span class="o">=</span><span class="n">linenos</span>
        <span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">linenos</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&lt;div class=&quot;source&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/div&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">code</span>
        <span class="k">return</span> <span class="n">code</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&lt;pre class=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;&lt;code&gt;</span><span class="si">%s</span><span class="s">&lt;/code&gt;&lt;/pre&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">lang</span><span class="p">,</span> <span class="n">mistune</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">HighlightMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">block_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
        <span class="n">inlinestyles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;inlinestyles&#39;</span><span class="p">)</span>
        <span class="n">linenos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;linenos&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">block_code</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">inlinestyles</span><span class="p">,</span> <span class="n">linenos</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>这一步只是设置了相应的markdown文件的解析规则,然后使用如下命令生成相应的CSS渲染文件,本博客使用的是
vim的native配色方案,更多的配色方案请参考<a href="http://pygments.org/">pygment</a>官网.</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>pygmentize -f html -a .source -S native &gt; pygments.css
</pre></div>
</td></tr></table></div>
<h3>导航栏</h3>
<p>其次,博主重写了toc模块,抓取markdown文件中的二级标题作为博客的垂直导航栏的内容.</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#toc.py</span>
<span class="k">class</span> <span class="nc">TocMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">reset_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc_tree</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="s">&#39;&lt;h</span><span class="si">%d</span><span class="s"> id=&quot;toc-</span><span class="si">%d</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/h</span><span class="si">%d</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">level</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc_count</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">level</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toc_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="s">&#39;&lt;h</span><span class="si">%d</span><span class="s">&gt;</span><span class="si">%s</span><span class="s">&lt;/h</span><span class="si">%d</span><span class="s">&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">level</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">level</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toc_tree</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">toc_count</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">raw</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">def</span> <span class="nf">render_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Render TOC to HTML.</span>

<span class="sd">        :param level: render toc to the given level</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_toc</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_iter_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="n">first_level</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">last_level</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">yield</span> <span class="s">&#39;&lt;ul id=&quot;table-of-content&quot;&gt;</span><span class="se">\n</span><span class="s">&#39;</span>

        <span class="k">for</span> <span class="n">toc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc_tree</span><span class="p">:</span>
            <span class="n">index</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">toc</span>

            <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">:</span>
                <span class="c"># ignore this level</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">first_level</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># based on first level</span>
                <span class="n">first_level</span> <span class="o">=</span> <span class="n">l</span>
                <span class="n">last_level</span> <span class="o">=</span> <span class="n">l</span>
                <span class="k">yield</span> <span class="s">&#39;&lt;li&gt;&lt;a href=&quot;#toc-</span><span class="si">%d</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">last_level</span> <span class="o">==</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s">&#39;&lt;/li&gt;</span><span class="se">\n</span><span class="s">&lt;li&gt;&lt;a href=&quot;#toc-</span><span class="si">%d</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">last_level</span> <span class="o">==</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">last_level</span> <span class="o">=</span> <span class="n">l</span>
                <span class="k">yield</span> <span class="s">&#39;&lt;ul&gt;</span><span class="se">\n</span><span class="s">&lt;li&gt;&lt;a href=&quot;#toc-</span><span class="si">%d</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">last_level</span> <span class="o">&gt;</span> <span class="n">l</span><span class="p">:</span>
                <span class="c"># close indention</span>
                <span class="k">yield</span> <span class="s">&#39;&lt;/li&gt;&#39;</span>
                <span class="k">while</span> <span class="n">last_level</span> <span class="o">&gt;</span> <span class="n">l</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s">&#39;&lt;/ul&gt;</span><span class="se">\n</span><span class="s">&lt;/li&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">last_level</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">yield</span> <span class="s">&#39;&lt;li&gt;&lt;a href=&quot;#toc-</span><span class="si">%d</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="c"># close tags</span>
        <span class="k">yield</span> <span class="s">&#39;&lt;/li&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">while</span> <span class="n">last_level</span> <span class="o">&gt;</span> <span class="n">first_level</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s">&#39;&lt;/ul&gt;</span><span class="se">\n</span><span class="s">&lt;/li&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">last_level</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">yield</span> <span class="s">&#39;&lt;/ul&gt;</span><span class="se">\n</span><span class="s">&#39;</span>
</pre></div>
</td></tr></table></div>
<p>同样的,这里只是设置了markdown文件的解析规则,相应的二级标题的内容我们可以使用正则表达式获取.</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">findtoc</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;&lt;h2.*?&gt;(.*?)&lt;\/h2&gt;&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>
</pre></div>
</td></tr></table></div>
<p>最后需要将<b class="uk-text-success">HighlightMixin</b>类和<b class="uk-text-success">TocMixin</b>类加进Mistune
中.</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">TocRenderer</span><span class="p">(</span><span class="n">highlight</span><span class="o">.</span><span class="n">HighlightMixin</span><span class="p">,</span> <span class="n">toc</span><span class="o">.</span><span class="n">TocMixin</span> <span class="p">,</span><span class="n">mistune</span><span class="o">.</span><span class="n">Renderer</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</td></tr></table></div>
<h3>使用jinja2</h3>
<p>上述的工作做完之后,我们就可以着手具体的解析工作了.pyblog使用<a href="http://jinja.pocoo.org/">jinja2</a>渲染
HTML模板.废话不多说,解析markdown的代码如下.</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">parse_md</span><span class="p">(</span><span class="n">md_pwd</span><span class="p">,</span> <span class="n">mdp</span><span class="p">):</span>
    <span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">md_pwd</span><span class="p">)</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.html&quot;</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">dirname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">md_pwd</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">utils</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;../templates/utils.html&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;invalid md_pwd&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">mdp</span><span class="o">.</span><span class="n">renderer</span><span class="o">.</span><span class="n">reset_toc</span><span class="p">()</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">md</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">utils</span><span class="o">+</span><span class="n">md</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">mdp</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
    <span class="n">item_toc</span> <span class="o">=</span> <span class="n">findtoc</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">args</span><span class="p">[</span><span class="s">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">categories</span>
    <span class="n">args</span><span class="p">[</span><span class="s">&#39;basename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basename</span>
    <span class="n">args</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
    <span class="n">args</span><span class="p">[</span><span class="s">&#39;meta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_meta</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">args</span><span class="p">[</span><span class="s">&#39;item_toc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_toc</span>
    <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;blog&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>其中的args是位于markdown文件头的一些属性,我们依然可以使用正则表达式将它们提取出来.</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>

<span class="n">INDENTATION</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\n\s{2,}&#39;</span><span class="p">)</span>
<span class="n">META</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(\w+):\s*(.*(?:\n\s{2,}.*)*)\n&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">META</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">INDENTATION</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">rv</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)):]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">META</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rv</span><span class="p">,</span> <span class="n">text</span>
</pre></div>
</td></tr></table></div>
<p>当然了,为了避免愚蠢的每次都解析所有的md文件,pyblog提供了批量解析和单个文件解析的方案,在此就不多说了.</p>
<h2 id="toc-5">SEO</h2>
<p>待补充</p>
<h2 id="toc-6">扩展功能</h2>
<h3>数学公式</h3>
<p>这个不难,直接使用<a href="https://www.mathjax.org/">mathjax</a>,将下面的代码复制到
<b class="uk-text-success">&lt;body&gt;</b>标签内就可以使用了.</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span> 
    <span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span> 
        <span class="nx">tex2jax</span><span class="o">:</span> <span class="p">{</span><span class="nx">inlineMath</span><span class="o">:</span> <span class="p">[[</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;$&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;\\(&#39;</span><span class="p">,</span><span class="s1">&#39;\\)&#39;</span><span class="p">]]}</span> 
    <span class="p">});</span> 
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
    <span class="na">src=</span><span class="s">&quot;https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>
</td></tr></table></div>
<h3>评论框</h3>
<p>pyblog主要面向的是国内的用户,所以本着尽量避免翻墙的原则,选用了国内颇负盛名的<a href="http://www.uyan.cc/">友言</a>.
作为评论插件.登陆注册之后将你的专属js链接加入到博客模板即可.例如博主的专属js链接如下.</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;http://v2.uyan.cc/code/uyan.js?uid=2057486&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div>
</td></tr></table></div>
<div class="uk-alert uk-alert-warning">

    <i class="uk-icon-warning"></i>

    这是博主的代码,需要换成自己的,请谨慎使用
</div><h3>用户概览</h3>
<p>使用<a href="https://www.google.com/analytics/">Google Analytics</a>可以统计分析网站上发生的活动,十分强大.同样
的,需要注册登陆之后将自己的专属js代码加入到模板中即可生效.博主的专属js代码为:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">s</span><span class="p">,</span><span class="nx">o</span><span class="p">,</span><span class="nx">g</span><span class="p">,</span><span class="nx">r</span><span class="p">,</span><span class="nx">a</span><span class="p">,</span><span class="nx">m</span><span class="p">)</span>
 <span class="p">{</span><span class="nx">i</span><span class="p">[</span><span class="s1">&#39;GoogleAnalyticsObject&#39;</span><span class="p">]</span><span class="o">=</span><span class="nx">r</span><span class="p">;</span><span class="nx">i</span><span class="p">[</span><span class="nx">r</span><span class="p">]</span><span class="o">=</span><span class="nx">i</span><span class="p">[</span><span class="nx">r</span><span class="p">]</span><span class="o">||</span><span class="kd">function</span><span class="p">(){</span>
    <span class="p">(</span><span class="nx">i</span><span class="p">[</span><span class="nx">r</span><span class="p">].</span><span class="nx">q</span><span class="o">=</span><span class="nx">i</span><span class="p">[</span><span class="nx">r</span><span class="p">].</span><span class="nx">q</span><span class="o">||</span><span class="p">[]).</span><span class="nx">push</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)},</span><span class="nx">i</span><span class="p">[</span><span class="nx">r</span><span class="p">].</span><span class="nx">l</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="k">new</span> <span class="nb">Date</span><span class="p">();</span><span class="nx">a</span><span class="o">=</span><span class="nx">s</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span>
        <span class="nx">m</span><span class="o">=</span><span class="nx">s</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="nx">o</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span><span class="nx">a</span><span class="p">.</span><span class="nx">async</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="nx">a</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="nx">g</span><span class="p">;</span><span class="nx">m</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">m</span><span class="p">)</span>
 <span class="p">})(</span><span class="nb">window</span><span class="p">,</span><span class="nb">document</span><span class="p">,</span><span class="s1">&#39;script&#39;</span><span class="p">,</span><span class="s1">&#39;//www.google-analytics.com/analytics.js&#39;</span><span class="p">,</span><span class="s1">&#39;ga&#39;</span><span class="p">);</span>
   <span class="nx">ga</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;UA-66672167-1&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">);</span>
   <span class="nx">ga</span><span class="p">(</span><span class="s1">&#39;send&#39;</span><span class="p">,</span> <span class="s1">&#39;pageview&#39;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="uk-alert uk-alert-warning">

    <i class="uk-icon-warning"></i>

    这是博主的代码,需要换成自己的,请谨慎使用
</div><h3>自定义标签</h3>
<p>pyblog支持自定义标签,所有自定义的标签都在utils.html模板中:</p>
<div class="source"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span> <span class="n">macro</span> <span class="n">btn</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;primary&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;{link}&quot;</span> <span class="n">target</span><span class="o">=</span><span class="s">&quot;_blank&quot;</span><span class="o">&gt;&lt;</span><span class="n">button</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;uk-button uk-button-{type}&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span><span class="o">&gt;</span><span class="p">{</span><span class="n">value</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="p">{</span> <span class="n">endmacro</span> <span class="p">}</span>

<span class="p">{</span> <span class="n">macro</span> <span class="n">img</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="s">&#39;my_group&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;{src}&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">uk</span><span class="o">-</span><span class="n">lightbox</span><span class="o">=</span><span class="s">&quot;{group:&#39;{group}&#39;}&quot;</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;{title}&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;{src}&quot;</span> <span class="n">alt</span><span class="o">=</span><span class="s">&quot;{alt}&quot;</span> <span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="p">{</span> <span class="n">endmacro</span> <span class="p">}</span>

<span class="p">{</span> <span class="n">macro</span> <span class="n">alert</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;danger&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;uk-alert uk-alert-{type}&quot;</span><span class="o">&gt;</span>
    <span class="p">{</span> <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;warning&#39;</span> <span class="p">}</span>
    <span class="o">&lt;</span><span class="n">i</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;uk-icon-warning&quot;</span><span class="o">&gt;&lt;/</span><span class="n">i</span><span class="o">&gt;</span>
    <span class="p">{</span> <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;danger&#39;</span> <span class="p">}</span>
    <span class="o">&lt;</span><span class="n">i</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;uk-icon-bug&quot;</span><span class="o">&gt;&lt;/</span><span class="n">i</span><span class="o">&gt;</span>
    <span class="p">{</span> <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;success&#39;</span> <span class="p">}</span>
    <span class="o">&lt;</span><span class="n">i</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;uk-icon-check-square&quot;</span><span class="o">&gt;&lt;/</span><span class="n">i</span><span class="o">&gt;</span>
    <span class="p">{</span> <span class="k">else</span> <span class="p">}</span>
    <span class="o">&lt;</span><span class="n">i</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;uk-icon-info&quot;</span><span class="o">&gt;&lt;/</span><span class="n">i</span><span class="o">&gt;</span>
    <span class="p">{</span> <span class="n">endif</span> <span class="p">}</span>

<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="p">{</span> <span class="n">endmacro</span> <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="uk-alert uk-alert-warning">

    <i class="uk-icon-warning"></i>

    这些标签都是适应uikit框架的,用户可以修改适应其他的风格
</div><h2 id="toc-7">其他</h2>
<p>相关源码已托管于Github,有需要的朋友请自行下载使用.
<a href="https://github.com/genialwang/pyblog" target="_blank"><button class="uk-button uk-button-primary" type="button">获取源码</button></a></p>

                </div>
                <div class="uk-alert uk-alert-success">
                    若文中有误,欢迎指正
                </div>
            </div>
        </div>
    </div>

    <a href="#" onclick="gotoTop();return false;" class="totop"></a>

    <div class="uk-container uk-container-center">
        <!-- UY BEGIN -->
        <div id="uyan_frame"></div>
        <!-- UY END -->
    </div>

    <div class="uk-margin-large-top" style="background: #666;">
        <div class="uk-container uk-container-center uk-text-center">
            <div class="uk-panel uk-margin-top uk-margin-bottom">
                <p>
                    <a target="_blank" href="http://weibo.com/u/2935065297" class="uk-icon-button uk-icon-weibo"></a>
                    <a target="_blank" href="https://github.com/genialwang" class="uk-icon-button uk-icon-github"></a>
                    <a href="Mailto:wangbiao@ncic.ac.cn" class="uk-icon-button uk-icon-envelope"></a>
                </p>
                <p id = "info">本作品采用<a rel="license" href="http://creativecommons.org/licenses/by/3.0/cn/">知识共享署名 3.0 中国大陆许可协议</a>进行许可.</p>
            </div>
        </div>
    </div>

    <script src="../../static/js/jquery.min.js"></script>
    <script src="../../static/js/uikit.min.js"></script>
    <script src="../../static/js/components/sticky.min.js"></script>
    <script src="../../static/js/components/scrollspy.min.js"></script>
    <script src="../../static/js/components/smooth-scroll.min.js"></script>
    <script src="../../static/js/genialwang.js"></script>
    <script src="../../static/js/components/lightbox.min.js"></script>
    <script src="../../static/js/components/google_analytics.js"></script>
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2057486"></script>
</body>
</html>